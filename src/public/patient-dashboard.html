<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Patient Dashboard | BloodLink</title>
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="logo">
      <i class="fas fa-heartbeat"></i>
      <span>BloodLink</span>
    </div>
    <nav>
      <ul>
        <li><a href="patient-dashboard.html">Dashboard</a></li>
        <li>
          <a href="#" id="notifications-icon">
            <i class="fas fa-bell"></i>
            <span id="notification-badge">0</span>
          </a>
        </li>
        <li><a href="logout.html">Logout</a></li>
      </ul>
    </nav>
  </header>
  <aside>
    <ul>
      <li><a href="#">My Requests</a></li>
      <li><a href="#">My Profile</a></li>
      <li><a href="#">My Matches</a></li>
    </ul>
  </aside>
  <main>
    <h1>Welcome, Patient!</h1>
    <p>This is your dashboard where you can view your donation requests and track your notifications.</p>
    <div id="notifications-panel" class="notifications-panel">
      <h2>Notifications</h2>
      <div id="loading-spinner" class="spinner" style="display:none;"></div>
      <ul id="notifications-list">
        <!-- Notifications will be appended here -->
      </ul>
    </div>
  </main>

  <div id="toast-container"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const userId = localStorage.getItem('userId');
    if (userId) {
      socket.emit('join', userId);
    }
    
    socket.on('notification', (data) => {
      console.log('Received notification:', data);
      showToast(data.notification_message || 'New notification received');
      updateNotifications(data);
    });
    
    function showToast(message) {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.classList.add('toast');
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 5000);
    }
    
    function updateNotifications(notification) {
      const badge = document.getElementById('notification-badge');
      let count = parseInt(badge.textContent) || 0;
      count++;
      badge.textContent = count;
      
      const notificationsList = document.getElementById('notifications-list');
      const li = document.createElement('li');
      li.textContent = notification.notification_message || 'New notification';
      li.addEventListener('click', () => {
        markNotificationAsRead(notification.notification_id);
        li.style.textDecoration = 'line-through';
        count = Math.max(0, count - 1);
        badge.textContent = count;
      });
      notificationsList.appendChild(li);
    }
    
    async function markNotificationAsRead(notificationId) {
      try {
        const response = await fetch(`/api/notifications/${notificationId}/read`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        console.log('Notification marked as read:', data);
      } catch (err) {
        console.error('Error marking notification as read:', err);
      }
    }
    
    async function fetchNotifications() {
      const spinner = document.getElementById('loading-spinner');
      spinner.style.display = 'block';
      try {
        const response = await fetch(`/api/notifications?userId=${userId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        const notifications = await response.json();
        spinner.style.display = 'none';
        notifications.forEach(notification => updateNotifications(notification));
      } catch (error) {
        spinner.style.display = 'none';
        console.error('Error fetching notifications:', error);
      }
    }
    
    fetchNotifications();
  </script>
</body>
</html>
