<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Admin Dashboard | BloodLink</title>
    
    <!-- CSS Reset -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    
    <!-- Main dashboard styles -->
    <link rel="stylesheet" href="admin-dashboard.css" type="text/css">
    
    <!-- Font Awesome and Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <header>
    <div class="logo">
      <i class="fas fa-shield-alt"></i>
      <span>BloodLink Admin</span>
    </div>
    <nav>
      <ul>
        <li><a href="#overview">Dashboard</a></li>
        <li>
          <a href="#" id="notifications-icon">
            <i class="fas fa-bell"></i>
            <span id="notification-badge">0</span>
          </a>
          <!-- Notifications Panel -->
          <div class="notifications-panel" id="notifications-panel">
            <h3>Notifications</h3>
            <ul id="notifications-list"></ul>
          </div>
        </li>
        <li><a href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
    </nav>
  </header>

  <aside id="sidebar">
    <ul>
      <li><a href="#overview" class="active"><i class="fas fa-tachometer-alt"></i> Overview</a></li>
      <li><a href="#manage-users"><i class="fas fa-users"></i> Manage Users</a></li>
      <li><a href="#blood-requests"><i class="fas fa-tint"></i> Blood Requests</a></li>
      <li><a href="#reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
      <li><a href="#user-logs"><i class="fas fa-history"></i> User Logs</a></li>
      <li><a href="#system-settings"><i class="fas fa-cog"></i> System Settings</a></li>
    </ul>
  </aside>

  <main>
    <!-- Overview Section -->
    <section id="overview">
      <h1>Welcome, <span id="admin-name">Admin</span>! ðŸ‘‹</h1>
      <p>Monitor system activity and manage the platform.</p>
      
      <div class="system-metrics dashboard-grid">
        <div class="metric-card card">
          <div class="card-header">
            <h3>Total Users</h3>
            <i class="fas fa-users"></i>
          </div>
          <div class="metric-value card-value" id="total-users">0</div>
          <div class="card-details">
            <span class="badge user-role-pill role-donor" id="donor-count">0 Donors</span>
            <span class="badge user-role-pill role-patient" id="patient-count">0 Patients</span>
            <span class="badge user-role-pill role-institution" id="institution-count">0 Institutions</span>
          </div>
        </div>
        <div class="metric-card card">
          <div class="card-header">
            <h3>Active Users</h3>
            <i class="fas fa-user-check"></i>
          </div>
          <div class="metric-value card-value" id="active-users">0</div>
          <div class="card-trend trend-up">
            <i class="fas fa-arrow-up"></i>
            <span id="active-percentage">0% from last week</span>
          </div>
        </div>
        <div class="metric-card card">
          <div class="card-header">
            <h3>Blood Requests</h3>
            <i class="fas fa-clipboard-list"></i>
          </div>
          <div class="metric-value card-value" id="total-requests">0</div>
          <div class="card-details">
            <span class="badge user-role-pill role-patient badge-warning" id="pending-requests">0 Pending</span>
            <span class="badge user-role-pill role-donor badge-success" id="fulfilled-requests">0 Fulfilled</span>
          </div>
        </div>
        <div class="metric-card card">
          <div class="card-header">
            <h3>System Health</h3>
            <i class="fas fa-heartbeat"></i>
          </div>
          <div class="metric-value card-value" id="system-health">Good</div>
          <div class="card-details system-health">
            <span class="badge user-role-pill role-institution badge-info" id="system-uptime">Uptime: 100%</span>
            <span class="badge user-role-pill role-institution badge-info" id="response-time">Response: 120ms</span>
          </div>
        </div>
      </div>

      <!-- System Analytics -->
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-header card-header">
            <h3 class="chart-title">User Registration Trends</h3>
            <div class="chart-filters card-tools">
              <select id="registration-period">
                <option value="week">Last Week</option>
                <option value="month">Last Month</option>
                <option value="year">Last Year</option>
              </select>
            </div>
          </div>
          <canvas id="registration-chart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-header card-header">
            <h3 class="chart-title">Blood Request Statistics</h3>
            <div class="chart-filters card-tools">
              <select id="request-period">
                <option value="week">Last Week</option>
                <option value="month">Last Month</option>
                <option value="year">Last Year</option>
              </select>
            </div>
          </div>
          <canvas id="requests-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- Manage Users Section -->
    <section id="manage-users" class="user-management">
      <div class="section-header">
        <h2>Manage Users</h2>
        <div class="section-tools">
          <button class="btn btn-primary" onclick="openAddUserModal()">
            <i class="fas fa-user-plus"></i> Add User
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="user-filters search-filter">
            <div class="search-box input-group">
              <i class="fas fa-search"></i>
              <input type="text" id="user-search" placeholder="Search users...">
            </div>
            <div class="filter-group">
              <select id="role-filter" class="form-select">
                <option value="all">All Roles</option>
                <option value="donor">Donors</option>
                <option value="patient">Patients</option>
                <option value="institution">Healthcare Institutions</option>
                <option value="admin">Administrators</option>
              </select>
              <select id="status-filter" class="form-select">
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="suspended">Suspended</option>
              </select>
            </div>
          </div>
        </div>
        <div class="table-container">
          <table class="user-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Last Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="users-table">
              <!-- Users will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Blood Requests Section -->
    <section id="blood-requests" class="blood-requests">
      <h2>Blood Requests Management</h2>
      <div class="section-controls">
        <div class="search-filter">
          <input type="text" id="request-search" placeholder="Search requests...">
          <select id="status-filter">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="matched">Matched</option>
            <option value="fulfilled">Fulfilled</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <select id="urgency-filter">
            <option value="all">All Urgency</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
      </div>
      
      <div class="table-container">
        <table class="user-table">
          <thead>
            <tr>
              <th>Request ID</th>
              <th>Patient</th>
              <th>Institution</th>
              <th>Blood Type</th>
              <th>Units</th>
              <th>Urgency</th>
              <th>Request Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="blood-requests-table">
            <!-- Requests will be populated here -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Reports Section -->
    <section id="reports" class="reports">
      <h2>System Reports</h2>
      <div class="report-controls">
        <div class="date-range">
          <label for="date-from">From:</label>
          <input type="date" id="date-from">
          <label for="date-to">To:</label>
          <input type="date" id="date-to">
          <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
        </div>
      </div>
      
      <div class="charts-grid">
        <div class="chart-card">
          <h3 class="chart-title">User Registration Trends</h3>
          <canvas id="registration-chart"></canvas>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">Blood Request Statistics</h3>
          <canvas id="requests-chart"></canvas>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">Blood Type Distribution</h3>
          <canvas id="blood-type-chart"></canvas>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">System Performance</h3>
          <canvas id="performance-chart"></canvas>
        </div>
      </div>
    </section>

    <!-- User Logs Section -->
    <section id="user-logs" class="user-logs activity-log">
      <h2>User Activity Logs</h2>
      <div class="section-controls">
        <div class="search-filter">
          <input type="text" id="log-search" placeholder="Search logs...">
          <select id="log-type-filter">
            <option value="all">All Activities</option>
            <option value="login">Login</option>
            <option value="registration">Registration</option>
            <option value="request">Blood Request</option>
            <option value="donation">Donation</option>
            <option value="update">Profile Update</option>
          </select>
        </div>
      </div>
      
      <div class="table-container">
        <table class="user-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>User</th>
              <th>Action</th>
              <th>Details</th>
              <th>IP Address</th>
            </tr>
          </thead>
          <tbody id="activity-logs">
            <!-- Logs will be populated here -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- System Settings Section -->
    <section id="system-settings" class="system-settings">
      <h2>System Settings</h2>
      <div class="settings-grid">
        <div class="settings-card">
          <h3>Email Settings</h3>
          <form id="email-settings-form">
            <div class="input-group">
              <label for="smtp-host">SMTP Host</label>
              <input type="text" id="smtp-host" name="smtp_host">
            </div>
            <div class="input-group">
              <label for="smtp-port">SMTP Port</label>
              <input type="number" id="smtp-port" name="smtp_port">
            </div>
            <div class="input-group">
              <label for="smtp-user">SMTP Username</label>
              <input type="text" id="smtp-user" name="smtp_username">
            </div>
            <div class="input-group">
              <label for="smtp-pass">SMTP Password</label>
              <input type="password" id="smtp-pass" name="smtp_password">
            </div>
            <button type="submit" class="btn btn-primary">Save Email Settings</button>
          </form>
        </div>
        
        <div class="settings-card">
          <h3>Notification Settings</h3>
          <form id="notification-settings-form">
            <div class="checkbox-group">
              <label>
                <input type="checkbox" name="notify_new_user" checked>
                Notify on new user registration
              </label>
              <label>
                <input type="checkbox" name="notify_blood_request" checked>
                Notify on new blood request
              </label>
              <label>
                <input type="checkbox" name="notify_donation" checked>
                Notify on successful donation
              </label>
              <label>
                <input type="checkbox" name="notify_system_error" checked>
                Notify on system errors
              </label>
            </div>
            <button type="submit" class="btn btn-primary">Save Notification Settings</button>
          </form>
        </div>
        
        <div class="settings-card">
          <h3>Security Settings</h3>
          <form id="security-settings-form">
            <div class="input-group">
              <label for="session-timeout">Session Timeout (minutes)</label>
              <input type="number" id="session-timeout" name="session_timeout" min="5">
            </div>
            <div class="input-group">
              <label for="max-login-attempts">Max Login Attempts</label>
              <input type="number" id="max-login-attempts" name="max_login_attempts" min="3">
            </div>
            <div class="checkbox-group">
              <label>
                <input type="checkbox" name="require_2fa" checked>
                Require 2FA for admins
              </label>
              <label>
                <input type="checkbox" name="strong_password" checked>
                Enforce strong password policy
              </label>
            </div>
            <button type="submit" class="btn btn-primary">Save Security Settings</button>
          </form>
        </div>
      </div>
    </section>
  </main>

  <!-- Add User Modal -->
  <div id="add-user-modal" class="modal">
    <div class="modal-content">
      <h2>Add New User</h2>
      <form id="add-user-form">
        <div class="input-group">
          <label for="new-user-name">Name</label>
          <input type="text" id="new-user-name" required>
        </div>
        <div class="input-group">
          <label for="new-user-email">Email</label>
          <input type="email" id="new-user-email" required>
        </div>
        <div class="input-group">
          <label for="new-user-role">Role</label>
          <select id="new-user-role" required>
            <option value="">Select Role</option>
            <option value="donor">Donor</option>
            <option value="patient">Patient</option>
            <option value="institution">Healthcare Institution</option>
            <option value="admin">Administrator</option>
          </select>
        </div>
        <div class="button-group">
          <button type="submit" class="btn btn-primary primary-btn">Add User</button>
          <button type="button" class="btn btn-outline secondary-btn" onclick="closeAddUserModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Container for Notifications -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Loading Spinner -->
  <div id="loading-spinner" class="loading-spinner" style="display: none;">
    <i class="fas fa-spinner fa-spin"></i>
  </div>

  <!-- Scripts -->
  <script>
    // Check authentication on page load
    function checkAuth() {
      const token = localStorage.getItem('token');
      const userType = localStorage.getItem('userType');
      
      if (!token || userType !== 'admin') {
        // Clear any stale data
        localStorage.removeItem('token');
        localStorage.removeItem('userType');
        localStorage.removeItem('userId');
        localStorage.removeItem('userEmail');
        localStorage.removeItem('firstName');
        localStorage.removeItem('lastName');
        
        window.location.replace('/');
        return false;
      }
      return true;
    }

    // Initial auth check
    if (!checkAuth()) {
      console.log('Authentication check failed, redirecting to login');
    } else {
      console.log('Authentication successful, loading dashboard');
      // Set admin name in dashboard
      const firstName = localStorage.getItem('firstName');
      const lastName = localStorage.getItem('lastName');
      if (firstName && lastName) {
        document.getElementById('admin-name').textContent = `${firstName} ${lastName}`;
      }
    }

    // Prevent going back after logout
    window.history.forward();
  </script>
  <script src="admin.js"></script>

  <!-- Logout Script -->
  <script>
    function handleLogout() {
      // Clear all storage
      localStorage.clear();
      sessionStorage.clear();
      
      // Redirect to login page
      window.location.replace('/');
    }
  </script>
</body>
</html>