<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="admin-dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Blood Donation Admin</h2>
    </div>
    <div class="user-profile">
      <img src="https://via.placeholder.com/40" alt="Admin Avatar" class="avatar">
      <span>Admin User</span>
    </div>
    <nav>
      <a href="#users" class="active"><i class="fas fa-users"></i> User Management</a>
      <a href="#admin-management"><i class="fas fa-user-shield"></i> Admin Management</a>
      <a href="#blood-requests"><i class="fas fa-tint"></i> Blood Requests</a>
      <a href="#logs"><i class="fas fa-history"></i> Activity Logs</a>
      <a href="#stats"><i class="fas fa-chart-pie"></i> System Analytics</a>
      <a href="#reports"><i class="fas fa-file-alt"></i> Reports</a>
      <a href="#notifications"><i class="fas fa-bell"></i> Notifications</a>
    </nav>
    <div class="sidebar-footer">
      <button class="add-files-btn"><i class="fas fa-plus"></i> Add New User</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <!-- Header -->
    <div class="header">
      <h1>Overview</h1>
      <div class="header-right">
        <div class="search-bar">
          <input type="text" placeholder="Search something...">
          <i class="fas fa-search"></i>
        </div>
        <div class="notification-bell" onclick="toggleNotifications()">
          <i class="fas fa-bell"></i>
          <span class="badge" id="notificationCount">0</span>
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
              <h3>Notifications</h3>
            </div>
            <div class="notification-list" id="notificationListHeader"></div>
          </div>
        </div>
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- User Management -->
    <div class="section" id="users">
      <h2>User Management</h2>
      <div class="card">
        <table id="userTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Role</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Verified</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Admin Management -->
    <div class="section" id="admin-management">
      <h2>Admin Management</h2>
      <div class="card">
        <div class="admin-form">
          <h3>Add New Admin</h3>
          <input type="text" id="adminFirstName" placeholder="First Name">
          <input type="text" id="adminLastName" placeholder="Last Name">
          <input type="email" id="adminEmail" placeholder="Email">
          <input type="password" id="adminPassword" placeholder="Password">
          <input type="text" id="adminPhone" placeholder="Phone Number">
          <input type="date" id="adminDateCreated">
          <label><input type="checkbox" id="adminIsActive"> Is Active</label>
          <button onclick="addAdmin()">Add Admin</button>
        </div>
        <div class="search-bar" style="margin: 20px 0;">
          <input type="text" id="searchAdmin" placeholder="Search admins...">
          <i class="fas fa-search"></i>
        </div>
        <table id="adminTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Date Created</th>
              <th>Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </ ðŸ™‚

    <!-- Blood Requests -->
    <div class="section" id="blood-requests">
      <h2>Blood Requests</h2>
      <div class="card">
        <div class="request-form">
          <h3>Create New Blood Request</h3>
          <select id="requestBloodType">
            <option value="">Select Blood Type</option>
            <option value="A+">A+</option>
            <option value="A-">A-</option>
            <option value="B+">B+</option>
            <option value="B-">B-</option>
            <option value="AB+">AB+</option>
            <option value="AB-">AB-</option>
            <option value="O+">O+</option>
            <option value="O-">O-</option>
          </select>
          <input type="number" id="requestUnitsNeeded" placeholder="Units Needed">
          <select id="requestUrgencyLevel">
            <option value="">Select Urgency Level</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
          <input type="date" id="requestRequiredByDate">
          <textarea id="requestNotes" placeholder="Request Notes"></textarea>
          <button onclick="createBloodRequest()">Create Request</button>
        </div>
        <table id="requestTable">
          <thead>
            <tr>
              <th>Request ID</th>
              <th>Blood Type</th>
              <th>Units Needed</th>
              <th>Urgency</th>
              <th>Location</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Activity Logs -->
    <div class="section" id="logs">
      <h2>Activity Logs</h2>
      <div class="card">
        <div id="activityLogs"></div>
      </div>
    </div>

    <!-- System Analytics -->
    <div class="section" id="stats">
      <h2>System Analytics</h2>
      <div class="card">
        <canvas id="usageChart"></canvas>
      </div>
    </div>

    <!-- Reports -->
    <div class="section" id="reports">
      <h2>Reports</h2>
      <div class="card">
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button onclick="generateReport()">Generate Report</button>
        <div id="reportResult" style="margin-top: 20px;"></div>
      </div>
    </div>

    <!-- Notifications -->
    <div class="section" id="notifications">
      <h2>Notifications</h2>
      <div class="card">
        <div id="notificationList"></div>
      </div>
    </div>
  </div>

  <script>
   // Helper function to handle API requests and token expiration
   async function makeAuthenticatedRequest(url, options = {}) {
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Session expired. Please log in again.');
      window.location.href = '/login';
      throw new Error('No token found');
    }

    const defaultHeaders = {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    };

    const finalOptions = {
      ...options,
      headers: {
        ...defaultHeaders,
        ...options.headers
      }
    };

    const res = await fetch(url, finalOptions);
    if (res.status === 403 && (await res.clone().json()).error === 'Invalid token') {
      alert('Session expired. Please log in again.');
      localStorage.removeItem('token');
      localStorage.removeItem('userId');
      localStorage.removeItem('userType');
      localStorage.removeItem('email');
      window.location.href = '/login';
      throw new Error('Invalid token');
    }
    if (!res.ok) {
      let errorMessage = res.statusText;
      try {
        const errorData = await res.json();
        errorMessage = errorData.error || res.statusText;
      } catch (e) {
        // Response is not JSON, use statusText
      }
      throw new Error(`Request failed: ${errorMessage}`);
    }
    return res.json();
  }

    // Fetch users
    makeAuthenticatedRequest('/admin/users')
      .then(data => {
        const tbody = document.querySelector('#userTable tbody');
        data.forEach(user => {
          const row = `<tr>
            <td>${user.id}</td>
            <td>${user.name}</td>
            <td>${user.role}</td>
            <td>${user.status}</td>
            <td>${user.last_login || 'N/A'}</td>
            <td>${user.verified ? 'Yes' : 'No'}</td>
            <td>
              ${!user.verified ? `<button class="verify-btn" onclick="verifyUser(${user.id})"><i class="fas fa-check"></i> Verify</button>` : ''}
              <button class="deactivate-btn" onclick="deactivateUser(${user.id})"><i class="fas fa-ban"></i> Deactivate</button>
            </td>
          </tr>`;
          tbody.innerHTML += row;
        });
      })
      .catch(err => {
        console.error('Error fetching users:', err);
        alert('Error fetching users: ' + err.message);
      });

    // Fetch admins
    function fetchAdmins(searchTerm = '') {
      const url = searchTerm ? `/api/admin/search?q=${encodeURIComponent(searchTerm)}` : '/api/admin';
      makeAuthenticatedRequest(url)
        .then(data => {
          const tbody = document.querySelector('#adminTable tbody');
          tbody.innerHTML = '';
          data.forEach(admin => {
            const row = `
              <tr>
                <td>${admin.admin_id}</td>
                <td>${admin.first_name}</td>
                <td>${admin.last_name}</td>
                <td>${admin.email}</td>
                <td>${admin.phone_number}</td>
                <td>${admin.date_created}</td>
                <td>${admin.is_active ? 'Yes' : 'No'}</td>
                <td>
                  <button class="edit-btn" onclick="editAdmin(${admin.admin_id})"><i class="fas fa-edit"></i> Edit</button>
                  <button class="delete-btn" onclick="deleteAdmin(${admin.admin_id})"><i class="fas fa-trash"></i> Delete</button>
                </td>
              </tr>`;
            tbody.innerHTML += row;
          });
        })
        .catch(err => {
          console.error('Error fetching admins:', err);
          alert('Error fetching admins: ' + err.message);
        });
    }

    // Initial fetch of admins
    fetchAdmins();

    // Search admins
    document.getElementById('searchAdmin').addEventListener('input', (e) => {
      fetchAdmins(e.target.value);
    });

    function addAdmin() {
      const adminData = {
        first_name: document.getElementById('adminFirstName').value,
        last_name: document.getElementById('adminLastName').value,
        email: document.getElementById('adminEmail').value,
        password: document.getElementById('adminPassword').value,
        phone_number: document.getElementById('adminPhone').value,
        userType: 'admin'
      };
    
      if (!adminData.first_name || !adminData.last_name || !adminData.email || !adminData.password) {
        alert('Please fill in all required fields.');
        return;
      }
          
      makeAuthenticatedRequest('/api/auth/signup', {
        method: 'POST',
        body: JSON.stringify(adminData)
      })
        .then(() => {
          fetchAdmins();
          // Clear form
          document.getElementById('adminFirstName').value = '';
          document.getElementById('adminLastName').value = '';
          document.getElementById('adminEmail').value = '';
          document.getElementById('adminPassword').value = '';
          document.getElementById('adminPhone').value = '';
        })
        .catch(err => {
          console.error('Error adding admin:', err);
          alert('Error adding admin: ' + err.message);
        });
    }

    function editAdmin(adminId) {
      makeAuthenticatedRequest(`/api/admin/${adminId}`)
        .then(admin => {
          const newFirstName = prompt('Enter new first name:', admin.first_name);
          const newLastName = prompt('Enter new last name:', admin.last_name);
          const newEmail = prompt('Enter new email:', admin.email);
          const newPhone = prompt('Enter new phone number:', admin.phone_number);
          const newDateCreated = prompt('Enter new date created (YYYY-MM-DD):', admin.date_created);
          const newIsActive = confirm('Is this admin active?');

          // Client-side validation for required fields
          if (!newFirstName || !newLastName || !newEmail) {
            alert('First name, last name, and email are required.');
            throw new Error('Validation failed: Required fields missing');
          }

          // Basic email format validation
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(newEmail)) {
            alert('Please enter a valid email address.');
            throw new Error('Validation failed: Invalid email format');
          }

          const updatedAdmin = {
            first_name: newFirstName,
            last_name: newLastName,
            email: newEmail,
            phone_number: newPhone || admin.phone_number,
            date_created: newDateCreated || admin.date_created,
            is_active: newIsActive
          };

          return makeAuthenticatedRequest(`/api/admin/${adminId}`, {
            method: 'PUT',
            body: JSON.stringify(updatedAdmin)
          });
        })
        .then(() => {
          alert('Admin updated successfully!');
          fetchAdmins();
        })
        .catch(err => {
          console.error('Error updating admin:', err);
          alert('Error updating admin: ' + err.message);
        });
    }

    function deleteAdmin(adminId) {
      if (confirm('Are you sure you want to delete this admin?')) {
        makeAuthenticatedRequest(`/api/admin/${adminId}`, {
          method: 'DELETE'
        })
          .then(() => fetchAdmins())
          .catch(err => {
            console.error('Error deleting admin:', err);
            alert('Error deleting admin: ' + err.message);
          });
      }
    }

    // Fetch blood requests
    makeAuthenticatedRequest('/api/blood-requests')
      .then(response => {
        const tbody = document.querySelector('#requestTable tbody');
        response.data.forEach(request => {
          const row = `
            <tr>
              <td>${request.requestId}</td>
              <td>${request.bloodType}</td>
              <td>${request.unitsNeeded}</td>
              <td>${request.urgency}</td>
              <td>${request.location}</td>
              <td>${request.status}</td>
            </tr>`;
          tbody.innerHTML += row;
        });
      })
      .catch(err => {
        console.error('Error fetching blood requests:', err);
        alert('Error fetching blood requests: ' + err.message);
      });

    function createBloodRequest() {
      const requestData = {
        blood_type: document.getElementById('requestBloodType').value,
        units_needed: parseInt(document.getElementById('requestUnitsNeeded').value),
        urgency_level: document.getElementById('requestUrgencyLevel').value,
        required_by_date: document.getElementById('requestRequiredByDate').value,
        request_notes: document.getElementById('requestNotes').value
      };

      if (!requestData.blood_type || !requestData.units_needed || !requestData.urgency_level || !requestData.required_by_date) {
        alert('Please fill in all required fields.');
        return;
      }

      makeAuthenticatedRequest('/api/blood-requests', {
        method: 'POST',
        body: JSON.stringify(requestData)
      })
        .then(() => {
          // Refresh the request list
          location.reload();
        })
        .catch(err => {
          console.error('Error creating blood request:', err);
          alert('Error creating blood request: ' + err.message);
        });
    }

    // Fetch activity logs
    makeAuthenticatedRequest('/admin/activity-logs')
      .then(data => {
        const logsDiv = document.getElementById('activityLogs');
        data.forEach(log => {
          logsDiv.innerHTML += `<p>${log.timestamp}: ${log.action}</p>`;
        });
      })
      .catch(err => {
        console.error('Error fetching activity logs:', err);
        alert('Error fetching activity logs: ' + err.message);
      });

    // Fetch usage stats and render chart
    makeAuthenticatedRequest('/admin/usage-stats')
      .then(data => {
        const ctx = document.getElementById('usageChart').getContext('2d');
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Total Users', 'Total Requests', 'Total Donations'],
            datasets: [{
              data: [
                data.totalUsers || 0,
                data.totalRequests || 0,
                data.totalDonations || 0
              ],
              backgroundColor: ['#4CAF50', '#2196F3', '#F44336']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      })
      .catch(err => {
        console.error('Error fetching usage stats:', err);
        alert('Error fetching usage stats: ' + err.message);
      });

    // Fetch notifications and update both sections
    makeAuthenticatedRequest('/api/notifications')
      .then(data => {
        // Update notification count in the header
        const notificationCount = document.getElementById('notificationCount');
        const unreadCount = data.filter(n => !n.is_read).length;
        notificationCount.textContent = unreadCount;

        // Update notification list in the dropdown
        const notificationListHeader = document.getElementById('notificationListHeader');
        data.forEach(notification => {
          const isReadClass = notification.is_read ? 'read' : '';
          notificationListHeader.innerHTML += `
            <p class="${isReadClass}" onclick="markNotificationAsRead(${notification.notification_id}, this)">
              ${notification.created_at}: ${notification.notification_message}
            </p>`;
        });

        // Update notification list in the Notifications section
        const notificationList = document.getElementById('notificationList');
        data.forEach(notification => {
          const isReadClass = notification.is_read ? 'read' : '';
          notificationList.innerHTML += `
            <p class="${isReadClass}" onclick="markNotificationAsRead(${notification.notification_id}, this)">
              ${notification.created_at}: ${notification.notification_message}
            </p>`;
        });
      })
      .catch(err => {
        console.error('Error fetching notifications:', err);
        alert('Error fetching notifications: ' + err.message);
      });

    function toggleNotifications() {
      const dropdown = document.getElementById('notificationDropdown');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    function markNotificationAsRead(notificationId, element) {
      makeAuthenticatedRequest(`/api/notifications/${notificationId}/read`, {
        method: 'POST'
      })
        .then(() => {
          element.classList.add('read');
          // Update notification count
          const notificationCount = document.getElementById('notificationCount');
          const currentCount = parseInt(notificationCount.textContent);
          if (currentCount > 0) {
            notificationCount.textContent = currentCount - 1;
          }
        })
        .catch(err => {
          console.error('Error marking notification as read:', err);
          alert('Error marking notification as read: ' + err.message);
        });
    }

    function verifyUser(id) {
      makeAuthenticatedRequest(`/admin/users/${id}/verify`, {
        method: 'POST'
      })
        .then(() => location.reload())
        .catch(err => {
          console.error('Error verifying user:', err);
          alert('Error verifying user: ' + err.message);
        });
    }

    function deactivateUser(id) {
      makeAuthenticatedRequest(`/admin/users/${id}/deactivate`, {
        method: 'POST'
      })
        .then(() => location.reload())
        .catch(err => {
          console.error('Error deactivating user:', err);
          alert('Error deactivating user: ' + err.message);
        });
    }

    function generateReport() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
      }

      makeAuthenticatedRequest(`/admin/generate-report?startDate=${startDate}&endDate=${endDate}`)
        .then(data => {
          const reportDiv = document.getElementById('reportResult');
          if (data.length === 0) {
            reportDiv.innerHTML = '<p>No donations found for the selected date range.</p>';
            return;
          }
          let table = `
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Donor ID</th>
                  <th>Units Donated</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>`;
          data.forEach(donation => {
            table += `
              <tr>
                <td>${donation.donation_id}</td>
                <td>${donation.donor_id}</td>
                <td>${donation.units_donated}</td>
                <td>${donation.date}</td>
              </tr>`;
          });
          table += '</tbody></table>';
          reportDiv.innerHTML = table;
        })
        .catch(err => {
          console.error('Error generating report:', err);
          alert('Error generating report: ' + err.message);
        });
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    }
  </script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'929a941fff9253bb',t:'MTc0MzUzNjY0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>