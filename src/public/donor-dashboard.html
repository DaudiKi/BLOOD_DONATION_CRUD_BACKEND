<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Donor Dashboard</title><head>
  <link rel="stylesheet" href="donor-dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
    body { font-family: Arial, sans-serif; margin: 0; }
    .header { background: #333; color: white; padding: 10px; text-align: center; }
    .sidebar { width: 200px; background: #f4f4f4; position: fixed; height: 100%; padding-top: 20px; }
    .sidebar a { display: block; padding: 10px; text-decoration: none; color: #333; }
    .main { margin-left: 220px; padding: 20px; }
    table { width: 100%; border-collapse: collapse; }
    table, th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Donor Dashboard</h1>
    <button onclick="logout()">Logout</button>
  </div>
  <div class="sidebar">
    <a href="#profile">Profile</a>
    <a href="#availability">Availability Status</a>
    <a href="#requests">Blood Requests</a>
    <a href="#history">Donation History</a>
  </div>
  <div class="main">
    <h2 id="profile">Profile</h2>
    <div id="profileInfo"></div>
    <button onclick="showEditProfileForm()">Edit Profile</button>
    <div id="editProfileForm" style="display: none;">
      <input type="text" id="name" placeholder="Name">
      <input type="text" id="blood_type" placeholder="Blood Type">
      <input type="text" id="location" placeholder="Location">
      <input type="text" id="contact" placeholder="Contact">
      <button onclick="updateProfile()">Update</button>
    </div>

    <h2 id="availability">Availability Status</h2>
    <label><input type="checkbox" id="availability" onchange="updateAvailability()"> Available to Donate</label>
    <p id="availabilityStatus"></p>

    <h2 id="requests">Blood Requests</h2>
    <table id="requestTable">
      <thead>
        <tr><th>ID</th><th>Patient Name</th><th>Blood Type</th><th>Location</th><th>Urgency</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2 id="history">Donation History</h2>
    <table id="historyTable">
      <thead>
        <tr><th>ID</th><th>Date</th><th>Patient Name</th><th>Blood Type</th><th>Location</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Fetch profile
    fetch('/donor/profile', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') } })
      .then(res => res.json())
      .then(data => {
        const profileDiv = document.getElementById('profileInfo');
        profileDiv.innerHTML = `
          <p>Name: ${data.name}</p>
          <p>Blood Type: ${data.blood_type}</p>
          <p>Location: ${data.location}</p>
          <p>Contact: ${data.contact}</p>`;
        document.getElementById('availability').checked = data.availability;
        document.getElementById('availabilityStatus').innerText = `Last Updated: ${data.last_updated || 'N/A'}`;
      });

    function showEditProfileForm() {
      document.getElementById('editProfileForm').style.display = 'block';
    }

    function updateProfile() {
      const name = document.getElementById('name').value;
      const blood_type = document.getElementById('blood_type').value;
      const location = document.getElementById('location').value;
      const contact = document.getElementById('contact').value;
      fetch('/donor/profile', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, blood_type, location, contact })
      }).then(() => location.reload());
    }

    function updateAvailability() {
      const available = document.getElementById('availability').checked;
      fetch('/donor/availability', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ available })
      }).then(() => location.reload());
    }

    // Fetch blood requests
    fetch('/donor/requests', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') } })
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector('#requestTable tbody');
        data.forEach(request => {
          const row = `<tr>
            <td>${request.id}</td>
            <td>${request.patient_name}</td>
            <td>${request.blood_type}</td>
            <td>${request.location}</td>
            <td>${request.urgency}</td>
            <td>${request.status}</td>
            <td><button onclick="acceptRequest(${request.id})">Accept</button></td>
          </tr>`;
          tbody.innerHTML += row;
        });
      });

    function acceptRequest(id) {
      fetch(`/donor/requests/${id}/accept`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      }).then(() => location.reload());
    }

    // Fetch donation history
    fetch('/donor/history', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') } })
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector('#historyTable tbody');
        data.forEach(history => {
          const row = `<tr>
            <td>${history.id}</td>
            <td>${history.date}</td>
            <td>${history.patient_name}</td>
            <td>${history.blood_type}</td>
            <td>${history.location}</td>
            <td>${history.status}</td>
          </tr>`;
          tbody.innerHTML += row;
        });
      });

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    }
  </script>
</body>
</html>